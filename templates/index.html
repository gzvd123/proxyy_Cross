<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventory Merge Studio</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="page">
    <header class="hero">
      <div class="brand">
        <img src="{{ url_for('static', filename='logo.svg') }}" alt="Inventory Merge Studio" class="logo">
        <div>
          <p class="eyebrow">Inventory Merge Studio</p>
          <h1>G·ªôp nhanh c√°c b√°o c√°o t·ªìn kho</h1>
          <p class="lead">Upload to√†n b·ªô file Excel c√≥ ch·ª©a <code>{{ config.file_pattern }}</code>, h·ªá th·ªëng s·∫Ω g·ªôp v√† chu·∫©n ho√° c·ªôt cho b·∫°n v·ªõi tr·∫£i nghi·ªám UI c·∫•p t·∫≠p ƒëo√†n.</p>
        </div>
      </div>
      <div class="hero-meta">
        <div class="meta-card">
          <p class="label">Sheet</p>
          <p class="value">{{ config.sheet_name }}</p>
        </div>
        <div class="meta-card">
          <p class="label">C·ªôt c·∫ßn c√≥</p>
          <p class="value columns">{{ columns|join(', ') }}</p>
        </div>
      </div>
    </header>

    <main class="card">
      <div class="card-header">
        <h2>T·∫£i file l√™n &amp; g·ªôp</h2>
        <p>Ch√∫ng t√¥i t·ª± ƒë·ªông b·ªè qua file t·∫°m (~$), th√™m c·ªôt c√≤n thi·∫øu v·ªõi gi√° tr·ªã tr·ªëng v√† hi·ªÉn th·ªã b√°o c√°o sau khi g·ªôp.</p>
      </div>
      <form id="upload-form" class="uploader" enctype="multipart/form-data">
        <label class="dropzone" for="file-input" id="dropzone">
          <input id="file-input" type="file" name="files" accept=".xlsx,.xls" multiple>
          <div class="dropzone-copy">
            <p class="headline">K√©o th·∫£ ho·∫∑c ch·ªçn file Excel</p>
            <p class="sub">H·ªó tr·ª£ nhi·ªÅu file c√πng l√∫c ‚Ä¢ T·ª± ƒë·ªông nh·∫≠n bi·∫øt sheet "{{ config.sheet_name }}"</p>
            <div class="pill">K√©o th·∫£ h√†ng lo·∫°t ‚Ä¢ Kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng</div>
          </div>
        </label>

        <div class="file-stats" id="file-stats">
          <div>
            <p class="label">ƒê√£ ch·ªçn</p>
            <p class="value" id="file-count">0 file</p>
          </div>
          <div>
            <p class="label">T·ªïng dung l∆∞·ª£ng</p>
            <p class="value" id="file-size">0 KB</p>
          </div>
          <div>
            <p class="label">T√™n file</p>
            <p class="value columns" id="file-names">Ch∆∞a c√≥ file n√†o</p>
          </div>
        </div>

        <div class="progress" id="progress">
          <div class="progress-bar" id="progress-bar"></div>
          <div class="progress-label" id="progress-label">Ch∆∞a b·∫Øt ƒë·∫ßu</div>
        </div>

        <button type="submit" class="primary" id="submit-btn">G·ªôp &amp; t·∫£i xu·ªëng</button>
      </form>
      <div id="status" class="status" aria-live="polite"></div>
    </main>

    <section class="footer">
      <p>Build with ‚ù§Ô∏è cho ƒë·ªôi v·∫≠n h√†nh. K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c t·∫£i xu·ªëng d∆∞·ªõi d·∫°ng <strong>{{ config.output_filename }}</strong>.</p>
    </section>
  </div>

  <script>
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const statusBox = document.getElementById('status');
    const dropzone = document.getElementById('dropzone');
    const fileCountEl = document.getElementById('file-count');
    const fileSizeEl = document.getElementById('file-size');
    const fileNamesEl = document.getElementById('file-names');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const submitBtn = document.getElementById('submit-btn');

    function setStatus(message, tone = 'info') {
      statusBox.textContent = message;
      statusBox.dataset.tone = tone;
    }

    function humanFileSize(bytes) {
      if (!bytes) return '0 KB';
      const units = ['B', 'KB', 'MB', 'GB'];
      const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
      const value = bytes / Math.pow(1024, exponent);
      return `${value.toFixed(value >= 10 ? 0 : 1)} ${units[exponent]}`;
    }

    function updateFileStats(files) {
      const list = Array.from(files);
      const totalSize = list.reduce((sum, f) => sum + f.size, 0);
      fileCountEl.textContent = `${list.length} file`;
      fileSizeEl.textContent = humanFileSize(totalSize);
      fileNamesEl.textContent = list.length ? list.map(f => f.name).join(', ') : 'Ch∆∞a c√≥ file n√†o';
    }

    function setProgress(value, label) {
      progressBar.style.width = `${value}%`;
      progressLabel.textContent = label;
    }

    function handleFiles(files) {
      if (!files || !files.length) return;
      const dataTransfer = new DataTransfer();
      for (const file of files) {
        dataTransfer.items.add(file);
      }
      fileInput.files = dataTransfer.files;
      updateFileStats(fileInput.files);
      setStatus(`${fileInput.files.length} file ƒë√£ s·∫µn s√†ng.`, 'info');
    }

    dropzone.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropzone.classList.add('dragging');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragging');
    });

    dropzone.addEventListener('drop', (event) => {
      event.preventDefault();
      dropzone.classList.remove('dragging');
      handleFiles(event.dataTransfer.files);
    });

    fileInput.addEventListener('change', (event) => {
      handleFiles(event.target.files);
    });

    async function handleSubmit(event) {
      event.preventDefault();
      if (!fileInput.files.length) {
        setStatus('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file Excel.', 'warn');
        return;
      }
      setStatus('ƒêang t·∫£i l√™n v√† g·ªôp... ‚è≥', 'info');
      setProgress(15, 'ƒêang chu·∫©n b·ªã file');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ƒêang g·ªôp...';
      const formData = new FormData();
      for (const file of fileInput.files) {
        formData.append('files', file);
      }

      try {
        const response = await fetch('/api/merge', { method: 'POST', body: formData });
        setProgress(45, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu');
        if (!response.ok) {
          const payload = await response.json();
          setStatus(payload.error || 'C√≥ l·ªói x·∫£y ra khi g·ªôp file.', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'G·ªôp & t·∫£i xu·ªëng';
          setProgress(0, 'Ch∆∞a b·∫Øt ƒë·∫ßu');
          return;
        }

        const blob = await response.blob();
        setProgress(75, 'ƒêang t·∫°o file k·∫øt qu·∫£');
        const filename = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || '{{ config.output_filename }}';
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);

        setProgress(100, 'Ho√†n t·∫•t ‚úì');
        setStatus('üéâ G·ªôp xong! File ƒëang ƒë∆∞·ª£c t·∫£i xu·ªëng.', 'success');

        const summaryHeader = response.headers.get('X-Merge-Report');
        if (summaryHeader) {
          try {
            const summary = JSON.parse(summaryHeader);
            const report = [
              `ƒê√£ g·ªôp ${summary.file_count} file`,
              `${summary.total_rows} d√≤ng d·ªØ li·ªáu`,
              'Chi ti·∫øt: ' + summary.details.map(d => `${d.file}${d.rows ? ` (${d.rows} d√≤ng)` : ''}${d.missing_columns?.length ? ` thi·∫øu: ${d.missing_columns.join(', ')}` : ''}${d.error ? ` l·ªói: ${d.error}` : ''}`).join(' ‚Ä¢ ')
            ].join(' ‚Ä¢ ');
            setStatus(`üìä ${report}`, 'success');
          } catch (error) {
            console.warn('Failed to parse summary header', error);
          }
        }
      } catch (error) {
        console.error(error);
        setStatus('C√≥ l·ªói x·∫£y ra khi g·ªçi API.', 'error');
        setProgress(0, 'Ch∆∞a b·∫Øt ƒë·∫ßu');
      }
      submitBtn.disabled = false;
      submitBtn.textContent = 'G·ªôp & t·∫£i xu·ªëng';
    }

    form.addEventListener('submit', handleSubmit);
  </script>
</body>
</html>
